<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MathUniverse | Ultimate Platform</title>
    <meta name="theme-color" content="#008080">

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&family=Segoe+UI:wght@300;400;600;700&family=Fredoka:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' },
            options: { enableMenu: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            --radius: 12px;
            --header-h: 65px;
            --sidebar-w: 280px;
            --font-en: 'Segoe UI', sans-serif;
            --font-ar: 'Cairo', sans-serif;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 1. DEFAULT (Professional) */
        [data-theme="default"] {
            --primary: #008080; --primary-dark: #006666; --secondary: #4361ee;
            --accent: #f72585; --success: #2ec4b6; --warning: #ffb703; --danger: #e63946;
            --gold: #ffd700;
            --bg-body: #f0f2f5; --bg-panel: #ffffff; --bg-glass: rgba(255, 255, 255, 0.95);
            --text-main: #1d3557; --text-muted: #6c757d; --border: #e9ecef;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* 2. PLAYFUL (Kids) */
        [data-theme="playful"] {
            --primary: #FF9F1C; --primary-dark: #e08e12; --secondary: #2EC4B6;
            --accent: #FFBF69; --success: #2ec4b6; --warning: #FF9F1C; --danger: #e71d36;
            --gold: #FFD700;
            --bg-body: #CBF3F0; --bg-panel: #FFFFFF; --bg-glass: rgba(255, 255, 255, 0.9);
            --text-main: #2B2D42; --text-muted: #5D5D81; --border: #FFBF69;
            --shadow: 4px 4px 0px rgba(0,0,0,0.1);
            --radius: 20px;
            --font-en: 'Fredoka', sans-serif;
        }

        /* 3. HACKER (Teens) */
        [data-theme="hacker"] {
            --primary: #00ff41; --primary-dark: #008f11; --secondary: #008f11;
            --accent: #003b00; --success: #00ff41; --warning: #f2ff00; --danger: #ff0000;
            --gold: #f2ff00;
            --bg-body: #0d0208; --bg-panel: #001100; --bg-glass: rgba(0, 17, 0, 0.95);
            --text-main: #00ff41; --text-muted: #008f11; --border: #003b00;
            --shadow: 0 0 15px rgba(0, 255, 65, 0.2);
            --radius: 0px;
            --font-en: 'JetBrains Mono', monospace;
        }

        /* 4. BLOSSOM (Aesthetic) */
        [data-theme="blossom"] {
            --primary: #ff8fab; --primary-dark: #fb6f92; --secondary: #ffc2d1;
            --accent: #ffe5ec; --success: #90be6d; --warning: #f9bc60; --danger: #ef476f;
            --gold: #f9bc60;
            --bg-body: #fff0f3; --bg-panel: #ffffff; --bg-glass: rgba(255, 255, 255, 0.8);
            --text-main: #590d22; --text-muted: #a4133c; --border: #ffccd5;
            --shadow: 0 8px 20px rgba(255, 143, 171, 0.15);
            --radius: 16px;
        }

        /* 5. MIDNIGHT (Dark) */
        [data-theme="midnight"] {
            --primary: #3a86ff; --primary-dark: #0056b3; --secondary: #8338ec;
            --accent: #ff006e; --success: #06d6a0; --warning: #ffbe0b; --danger: #ff006e;
            --gold: #ffbe0b;
            --bg-body: #0a0a12; --bg-panel: #161622; --bg-glass: rgba(22, 22, 34, 0.95);
            --text-main: #e0e6ed; --text-muted: #94a3b8; --border: #2d2d3f;
            --shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* --- GLOBAL CSS --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        html[lang="en"] { font-family: var(--font-en); }
        html[lang="ar"] { font-family: var(--font-ar); }
        
        body { 
            margin: 0; background: var(--bg-body); color: var(--text-main); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            transition: var(--transition);
        }

        /* RTL Logic */
        .margin-start { margin-inline-start: 10px; }
        .margin-end { margin-inline-end: 10px; }
        [dir="rtl"] { direction: rtl; text-align: right; }
        [dir="ltr"] { direction: ltr; text-align: left; }
        [dir="rtl"] .fa-chevron-right:before { content: "\f053"; } 
        [dir="rtl"] .fa-arrow-right:before { content: "\f060"; } 

        /* LAYOUT */
        header { 
            height: var(--header-h); background: var(--bg-glass); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; 
            align-items: center; padding: 0 1.5rem; z-index: 50; flex-shrink: 0;
            transition: var(--transition);
        }

        .app-body { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* SIDEBAR */
        aside { 
            width: var(--sidebar-w); background: var(--bg-panel); 
            border-inline-end: 1px solid var(--border); 
            display: flex; flex-direction: column; z-index: 40; 
            transition: var(--transition);
            overflow: hidden; 
        }
        body.sidebar-closed aside { width: 0; border: none; }
        
        @media (max-width: 900px) {
            aside { position: absolute; height: 100%; top: 0; width: 85%; }
            html[dir="ltr"] aside { left: -100%; border-right: 1px solid var(--border); }
            html[dir="ltr"] body.sidebar-open aside { left: 0; }
            html[dir="rtl"] aside { right: -100%; border-left: 1px solid var(--border); }
            html[dir="rtl"] body.sidebar-open aside { right: 0; }
        }

        .main-content { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; transition: var(--transition); }
        .view-section { display: none; height: 100%; overflow-y: auto; padding: 1.5rem; padding-bottom: 150px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        /* UI ELEMENTS */
        .btn { border: none; padding: 0.8rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-family: inherit; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        [data-theme="hacker"] .btn-primary { color: black; border: 1px solid var(--primary); }
        [data-theme="playful"] .btn-primary { box-shadow: 0 4px 0 #e08e12; color:white; }
        [data-theme="playful"] .btn-primary:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-action { width:100%; padding: 1rem; font-size: 1.2rem; justify-content: center; }

        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--text-main); }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        .panel { background: var(--bg-panel); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 1rem; transition: var(--transition); }
        .panel-header { padding: 1rem; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.02); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .panel-body { padding: 1.5rem; }
        .solver-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        
        /* INPUT AREA */
        .math-toolbar { display: flex; gap: 5px; flex-wrap: wrap; background: var(--bg-body); padding: 8px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; max-height: 120px; overflow-y: auto; }
        .math-btn { padding: 5px 10px; font-size: 0.9rem; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-main); border-radius: 4px; cursor: pointer; min-width: 35px; }
        .math-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        textarea.math-input { width: 100%; min-height: 100px; padding: 1rem; border: 2px solid var(--border); border-radius: 8px; background: var(--bg-body); color: var(--text-main); font-family: 'Courier New', monospace; font-size: 1.2rem; resize: vertical; }
        [dir="rtl"] textarea.math-input { direction: rtl; font-family: var(--font-ar); }

        /* WHITEBOARD */
        .canvas-container { margin-bottom: 15px; position: relative; }
        canvas.whiteboard-canvas { background: #ffffff; cursor: crosshair; width: 100%; height: 300px; border-radius: 8px; touch-action: none; border: 1px solid #ccc; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
        .wb-controls { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; align-items: center; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: var(--text-main); transform: scale(1.1); }
        input[type="range"] { accent-color: var(--primary); }

        /* SIDEBAR CREDITS */
        .sidebar-credits {
            margin-top: auto; border-top: 1px solid var(--border); padding: 1rem;
            display: flex; flex-direction: column; gap: 10px;
            background: var(--bg-body);
        }
        .credit-card {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: var(--bg-panel); border-radius: 8px; border: 1px solid var(--border);
            transition: 0.3s; font-size: 0.85rem;
        }
        .credit-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .credit-icon { font-size: 1.2rem; color: var(--primary); min-width: 25px; text-align: center; }
        .credit-info strong { display: block; color: var(--text-main); }
        .credit-link { color: var(--text-muted); text-decoration: none; display: flex; align-items: center; gap: 5px; margin-top: 2px; }
        .whatsapp-btn { color: #25D366; margin-inline-start: auto; font-size: 1.1rem; }

        /* LEADERBOARD TABLE */
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .lb-table th, .lb-table td { padding: 12px 10px; text-align: start; border-bottom: 1px solid var(--border); }
        .lb-table th { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
        .lb-row-highlight { background: rgba(var(--primary), 0.1); font-weight: bold; }
        .btn-sm-danger { padding: 4px 8px; font-size: 0.8rem; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* MISC */
        .theme-select { padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-main); cursor: pointer; font-weight: 600; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; background: var(--secondary); color: white; }
        .xp-bar-container { width: 80px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-inline-start: 8px; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; transition: width 0.5s; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal { background: var(--bg-panel); padding: 2rem; border-radius: var(--radius); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; color: var(--text-main); }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body data-theme="default">

    <!-- HEADER -->
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn btn-outline" id="menu-toggle" style="border:none; padding:5px;"><i class="fas fa-bars fa-lg"></i></button>
            <div style="font-weight:800; color:var(--primary); font-size:1.3rem; display:flex; align-items:center; gap:8px;">
                <i class="fas fa-atom fa-spin" style="animation-duration:10s"></i> <span data-i18n="app_name">MathUniverse</span>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="badge" style="background:var(--bg-body); color:var(--text-main); border:1px solid var(--border); cursor:pointer;" onclick="openModal('profile')">
                <span id="user-lvl-display">Lvl 1</span>
                <div class="xp-bar-container"><div id="header-xp-bar" class="xp-bar-fill"></div></div>
            </div>
            
            <select class="theme-select" id="theme-selector" onchange="changeTheme(this.value)">
                <option value="default">Default</option>
                <option value="playful">Playful</option>
                <option value="hacker">Hacker</option>
                <option value="blossom">Blossom</option>
                <option value="midnight">Midnight</option>
            </select>

            <button class="btn btn-outline" onclick="toggleLanguage()" style="font-family: 'Cairo', sans-serif; font-weight:bold;">
                <span id="lang-btn-text">عربي</span> <i class="fas fa-globe"></i>
            </button>
        </div>
    </header>

    <div class="app-body">
        <!-- SIDEBAR -->
        <aside id="sidebar">
            <div style="padding:1rem; flex:1; overflow-y:auto;">
                <div style="font-size:0.75rem; color:var(--text-muted); font-weight:bold; margin-bottom:10px;" data-i18n="nav_main">MAIN MENU</div>
                <button class="btn btn-outline" style="width:100%; justify-content:flex-start; margin-bottom:5px; border:none;" onclick="setView('solver')">
                    <i class="fas fa-calculator margin-end"></i> <span data-i18n="nav_solver">Solver</span>
                </button>
                <button class="btn btn-outline" style="width:100%; justify-content:flex-start; margin-bottom:5px; border:none;" onclick="setView('library')">
                    <i class="fas fa-book margin-end"></i> <span data-i18n="nav_library">Question Bank</span>
                </button>
                <button class="btn btn-outline" style="width:100%; justify-content:flex-start; margin-bottom:5px; border:none;" onclick="setView('dashboard')">
                    <i class="fas fa-chart-pie margin-end"></i> <span data-i18n="nav_dash">Progress</span>
                </button>
                <button class="btn btn-outline" style="width:100%; justify-content:flex-start; margin-bottom:5px; border:none;" onclick="openModal('import')">
                    <i class="fas fa-file-import margin-end"></i> <span data-i18n="nav_import">Import Questions</span>
                </button>
                <button class="btn btn-outline" style="width:100%; justify-content:flex-start; margin-bottom:5px; border:none;" onclick="openModal('settings')">
                    <i class="fas fa-cog margin-end"></i> <span data-i18n="settings">Settings</span>
                </button>
                
                <div style="font-size:0.75rem; color:var(--text-muted); font-weight:bold; margin:15px 0 10px;" data-i18n="nav_gamify">ZONE</div>
                <button class="btn btn-outline" style="width:100%; justify-content:flex-start; margin-bottom:5px; border:none;" onclick="setView('leaderboard')">
                    <i class="fas fa-trophy margin-end"></i> <span data-i18n="leaderboard">Leaderboard</span>
                </button>
            </div>

            <!-- SIDEBAR CREDITS (TEACHER FIRST, THEN CREATOR) -->
            <div class="sidebar-credits">
                <div class="credit-card">
                    <div class="credit-icon"><i class="fas fa-chalkboard-teacher"></i></div>
                    <div class="credit-info">
                        <strong data-i18n="teach_label">Teacher</strong>
                        <span data-i18n="teach_name">ENG.Nagy.Abdelraheem</span>
                        <a href="tel:01050770732" class="credit-link"><i class="fas fa-phone"></i> 01050770732</a>
                        <a href="https://wa.me/201050770732" target="_blank" class="whatsapp-btn"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                <div class="credit-card">
                    <div class="credit-icon"><i class="fas fa-laptop-code"></i></div>
                    <div class="credit-info">
                        <strong data-i18n="dev_label">Web Creator</strong>
                        <span data-i18n="dev_name">Abdelrahman.Gamal</span>
                        <a href="tel:01001395058" class="credit-link"><i class="fas fa-phone"></i> 01001395058</a>
                        <a href="https://wa.me/201001395058" target="_blank" class="whatsapp-btn"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            
            <!-- VIEW: SOLVER -->
            <div id="view-solver" class="view-section active">
                
                <!-- 1. INPUT -->
                <div class="panel">
                    <div class="panel-header">
                        <span data-i18n="input_title">Math Input</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-outline" style="padding:5px;" onclick="document.getElementById('math-input').value=''">C</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Math Toolbar -->
                        <div class="math-toolbar">
                            <button class="math-btn" onclick="insertSymbol('+')">+</button>
                            <button class="math-btn" onclick="insertSymbol('-')">−</button>
                            <button class="math-btn" onclick="insertSymbol('*')">×</button>
                            <button class="math-btn" onclick="insertSymbol('/')">÷</button>
                            <button class="math-btn" onclick="insertSymbol('=')">=</button>
                            <button class="math-btn" onclick="insertSymbol('^2')">x²</button>
                            <button class="math-btn" onclick="insertSymbol('^')">xʸ</button>
                            <button class="math-btn" onclick="insertSymbol('sqrt(')">√</button>
                            <button class="math-btn" onclick="insertSymbol('(')">(</button>
                            <button class="math-btn" onclick="insertSymbol(')')">)</button>
                            <button class="math-btn" onclick="insertSymbol('x')">x</button>
                            <button class="math-btn" onclick="insertSymbol('y')">y</button>
                            <button class="math-btn" onclick="insertSymbol('pi')">π</button>
                            <button class="math-btn" onclick="insertSymbol('sin(')">sin</button>
                            <button class="math-btn" onclick="insertSymbol('cos(')">cos</button>
                        </div>

                        <!-- Active Question Banner -->
                        <div id="active-question-banner" style="display:none; background:rgba(var(--primary),0.1); padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid var(--primary); font-size:0.9rem;">
                            <i class="fas fa-link"></i> <span data-i18n="active_q">Solving Imported Question</span>
                            <button style="float:right; border:none; background:none; cursor:pointer; color:var(--text-main);" onclick="clearActiveQuestion()"><i class="fas fa-times"></i></button>
                        </div>

                        <textarea id="math-input" class="math-input" data-i18n-ph="input_ph" placeholder="Enter equation..."></textarea>
                        
                        <div style="margin-top:10px;">
                            <label style="display:flex; align-items:center; gap:5px; font-size:0.9rem;">
                                <input type="checkbox" id="arabic-numerals-toggle"> <span data-i18n="ar_numerals">Arabic Numerals (١٢٣)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 2. WHITEBOARDS (No height controls) -->
                <div class="panel">
                    <div class="panel-header">
                        <span data-i18n="whiteboard_title">Whiteboard / Sketchpad</span>
                        <button class="btn btn-primary" style="padding:2px 8px; font-size:0.8rem;" onclick="addNewWhiteboard()">+ New Board</button>
                    </div>
                    <div class="panel-body" id="whiteboards-container" style="padding:10px;">
                        <!-- Boards here -->
                    </div>
                </div>

                <!-- 3. ANSWER CHECKER (New) -->
                <div class="panel" style="border-left: 4px solid var(--accent);">
                    <div class="panel-header"><i class="fas fa-check-double"></i> Check Your Answer</div>
                    <div class="panel-body" style="display:flex; gap:10px; align-items:center;">
                        <input type="text" id="user-answer-input" class="math-input" style="min-height:45px; height:45px; margin:0;" placeholder="Type final answer here...">
                        <button class="btn btn-primary" onclick="checkAnswer()">Check</button>
                    </div>
                    <div id="check-result" style="margin-top:10px; padding:0 1.5rem;"></div>
                </div>

                <!-- 4. SOLVE BUTTON (Small, at End) -->
                <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="solveProblem()">
                        <i class="fas fa-eye margin-end"></i> Reveal Solution
                    </button>
                </div>

                <!-- 5. SOLUTION OUTPUT -->
                <div class="panel">
                    <div class="panel-header">
                        <span data-i18n="solution_title">Solution & Steps</span>
                        <button class="btn btn-outline" style="padding:2px 8px; font-size:0.8rem;" onclick="copySolution()"><i class="fas fa-copy"></i></button>
                    </div>
                    <div class="panel-body" id="solution-output" style="min-height:100px;">
                        <div style="text-align:center; color:var(--text-muted); margin-top:20px;">
                            <p data-i18n="empty_state">Ready to solve! Click 'Reveal Solution' if stuck.</p>
                        </div>
                    </div>
                    <!-- Optional Graph Area -->
                    <div id="plot-area" style="width:100%; height:0px;"></div>
                </div>
            </div>

            <!-- VIEW: LIBRARY -->
            <div id="view-library" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2 data-i18n="library_title">Question Library</h2>
                    <button class="btn btn-outline" style="color:var(--danger); border-color:var(--danger);" onclick="clearLibrary()"><i class="fas fa-trash"></i></button>
                </div>
                <div id="library-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:1rem;">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section">
                <h2 data-i18n="my_stats">My Statistics</h2>
                <div class="solver-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="panel" style="text-align:center;">
                        <i class="fas fa-fire fa-3x" style="color:orange; margin-bottom:10px;"></i>
                        <h1 id="streak-disp">0</h1>
                        <p class="text-muted" data-i18n="streak">Day Streak</p>
                    </div>
                    <div class="panel" style="text-align:center;">
                        <i class="fas fa-check-circle fa-3x" style="color:var(--success); margin-bottom:10px;"></i>
                        <h1 id="solved-disp">0</h1>
                        <p class="text-muted" data-i18n="problems_solved">Problems Solved</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: LEADERBOARD -->
            <div id="view-leaderboard" class="view-section">
                <h2 data-i18n="leaderboard">Leaderboard</h2>
                
                <!-- Admin Panel -->
                <div class="panel" style="border:1px dashed var(--primary); background:rgba(var(--primary), 0.05);">
                    <div class="panel-header" style="background:transparent; border:none;">
                        <span><i class="fas fa-user-plus"></i> Add Student (Admin)</span>
                    </div>
                    <div class="panel-body" style="padding-top:0; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                        <div style="flex:2; min-width:150px;">
                            <label style="font-size:0.8rem">Name</label>
                            <input type="text" id="new-student-name" class="math-input" style="min-height:40px; height:40px; padding:5px;">
                        </div>
                        <div style="flex:1; min-width:80px;">
                            <label style="font-size:0.8rem">Points</label>
                            <input type="number" id="new-student-points" class="math-input" style="min-height:40px; height:40px; padding:5px;">
                        </div>
                        <button class="btn btn-primary" onclick="addStudent()">Add</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-body">
                        <table class="lb-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>XP</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal">
            <h3 data-i18n="settings">Settings</h3>
            <p class="text-muted">Manage your application data.</p>
            
            <div style="margin-top:20px; padding:15px; border:1px solid var(--danger); border-radius:8px; background:rgba(231, 29, 54, 0.05);">
                <strong style="color:var(--danger)">Danger Zone</strong>
                <p style="font-size:0.9rem; margin:5px 0;">This will delete all progress, students, and settings.</p>
                <button class="btn btn-outline" style="color:var(--danger); border-color:var(--danger); width:100%;" onclick="clearAllData()">
                    <i class="fas fa-bomb"></i> Reset All Data
                </button>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- MODAL: IMPORT -->
    <div id="modal-import" class="modal-overlay">
        <div class="modal">
            <h3 data-i18n="import_title">Import Questions</h3>
            <div class="drop-zone" id="drop-zone">
                <i class="fas fa-cloud-upload-alt fa-3x" style="color:var(--primary);"></i>
                <p data-i18n="drop_desc">Drag JSON file here or click to upload</p>
                <input type="file" id="file-input" hidden accept=".json,.csv">
            </div>
            <div style="margin-top:1rem; text-align:right;">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:30px; opacity:0; pointer-events:none; transition:0.3s; z-index:200;"></div>

    <script>
        /* --- 1. CONFIG & STATE --- */
        const i18n = {
            en: {
                app_name: "MathUniverse", nav_main: "MAIN MENU", nav_solver: "Solver", nav_dash: "Progress", nav_import: "Import Questions", nav_library: "Question Bank", nav_gamify: "ZONE", leaderboard: "Leaderboard",
                input_title: "1. Math Input", input_ph: "Enter equation...", ar_numerals: "Arabic Numerals (١٢٣)", solve: "SOLVE",
                solution_title: "Solution & Steps", empty_state: "Use 'Check Answer' first, then Reveal Solution.", whiteboard_title: "2. Whiteboard / Sketchpad",
                my_stats: "My Statistics", streak: "Streak", problems_solved: "Solved", badges: "Badges",
                dev_label: "Web Creator", dev_name: "Abdelrahman.Gamal", teach_label: "Teacher", teach_name: "ENG.Nagy.Abdelraheem",
                import_title: "Import Questions", drop_desc: "Drag JSON file here", library_title: "Question Library",
                step: "Step", difficulty: "Difficulty", active_q: "Solving Imported Question", settings: "Settings"
            },
            ar: {
                app_name: "الكون الرياضي", nav_main: "القائمة الرئيسية", nav_solver: "حل المسائل", nav_dash: "تقدمي", nav_import: "استيراد أسئلة", nav_library: "بنك الأسئلة", nav_gamify: "المنطقة", leaderboard: "لوحة المتصدرين",
                input_title: "١. إدخال المعادلة", input_ph: "أكتب معادلة...", ar_numerals: "أرقام عربية (١٢٣)", solve: "حل المسألة",
                solution_title: "الحل والخطوات", empty_state: "تحقق من إجابتك أولاً، ثم اظهر الحل.", whiteboard_title: "٢. السبورة البيضاء",
                my_stats: "إحصائياتي", streak: "تتابع", problems_solved: "مسائل محلولة", badges: "الأوسمة",
                dev_label: "مطور الموقع", dev_name: "عبدالرحمن.جمال", teach_label: "المدرس", teach_name: "م.ناجي.عبدالرحيم",
                import_title: "استيراد الأسئلة", drop_desc: "اسحب ملف JSON هنا", library_title: "بنك الأسئلة",
                step: "خطوة", difficulty: "الصعوبة", active_q: "حل سؤال مستورد", settings: "الإعدادات"
            }
        };

        const state = {
            lang: localStorage.getItem('lang') || 'en',
            theme: localStorage.getItem('theme') || 'default',
            xp: parseInt(localStorage.getItem('xp')) || 0,
            solved: parseInt(localStorage.getItem('solved')) || 0,
            streak: parseInt(localStorage.getItem('streak')) || 0,
            importedQuestions: JSON.parse(localStorage.getItem('importedQuestions')) || [],
            students: JSON.parse(localStorage.getItem('students')) || [],
            activeQuestion: null 
        };

        const mapEnToAr = { '0':'٠','1':'١','2':'٢','3':'٣','4':'٤','5':'٥','6':'٦','7':'٧','8':'٨','9':'٩' };

        /* --- 2. INIT --- */
        document.addEventListener('DOMContentLoaded', () => {
            changeTheme(state.theme);
            document.getElementById('theme-selector').value = state.theme;
            applyLanguage();
            renderStats();
            renderLibrary();
            renderLeaderboardTable();
            addNewWhiteboard(); 
            
            // Sidebar Toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                const body = document.body;
                if(window.innerWidth > 900) body.classList.toggle('sidebar-closed');
                else body.classList.toggle('sidebar-open');
            });

            // Drag Drop
            const dropZone = document.getElementById('drop-zone');
            dropZone.addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', handleFileImport);
        });

        /* --- 3. UTILS --- */
        function toArabicNumerals(str) { return str.toString().replace(/\d/g, d => mapEnToAr[d]); }
        function insertSymbol(val) {
            const input = document.getElementById('math-input');
            input.value += val; input.focus();
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.opacity = 1; t.style.transform = "translateX(-50%) translateY(-10px)";
            setTimeout(() => { t.style.opacity = 0; t.style.transform = "translateX(-50%) translateY(0)"; }, 3000);
        }

        /* --- 4. THEME & LANG --- */
        function changeTheme(t) { state.theme = t; localStorage.setItem('theme', t); document.body.setAttribute('data-theme', t); }
        function toggleLanguage() {
            state.lang = state.lang === 'en' ? 'ar' : 'en';
            localStorage.setItem('lang', state.lang);
            applyLanguage();
            renderLibrary();
            renderLeaderboardTable();
        }
        function applyLanguage() {
            const doc = document.documentElement;
            const isAr = state.lang === 'ar';
            doc.lang = state.lang; doc.dir = isAr ? 'rtl' : 'ltr';
            document.getElementById('lang-btn-text').textContent = isAr ? 'English' : 'عربي';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[state.lang][key]) el.textContent = i18n[state.lang][key];
            });
            document.getElementById('solved-disp').textContent = isAr ? toArabicNumerals(state.solved) : state.solved;
            document.getElementById('streak-disp').textContent = isAr ? toArabicNumerals(state.streak) : state.streak;
        }

        /* --- 5. SOLVER & CHECKER --- */
        function checkAnswer() {
            const userAns = document.getElementById('user-answer-input').value.trim().toLowerCase().replace(/\s/g, '');
            const resultDiv = document.getElementById('check-result');
            
            if(!userAns) {
                resultDiv.innerHTML = `<span style="color:orange">Please type an answer.</span>`;
                return;
            }

            let correctAns = "";
            let isCorrect = false;

            // Determine Correct Answer
            if (state.activeQuestion) {
                // Imported Question
                correctAns = state.activeQuestion.answer.toString().toLowerCase().replace(/\s/g, '');
            } else {
                // Manual Input -> Calculate
                try {
                    const input = document.getElementById('math-input').value;
                    const norm = input.replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)]);
                    correctAns = math.evaluate(norm).toString().toLowerCase().replace(/\s/g, '');
                } catch(e) {
                    resultDiv.innerHTML = `<span style="color:red">Invalid question input.</span>`;
                    return;
                }
            }

            // Simple Comparison (contains logic for flexible matching)
            if (userAns === correctAns || correctAns.includes(userAns) || userAns.includes(correctAns)) {
                isCorrect = true;
            }

            if(isCorrect) {
                resultDiv.innerHTML = `<span style="color:var(--success); font-weight:bold; font-size:1.1rem;"><i class="fas fa-check-circle"></i> Correct! Well done.</span>`;
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
            } else {
                resultDiv.innerHTML = `<span style="color:var(--danger); font-weight:bold;"><i class="fas fa-times-circle"></i> Try Again.</span>`;
            }
        }

        function solveProblem() {
            let input = document.getElementById('math-input').value;
            if(!input) return;
            const container = document.getElementById('solution-output');
            const isAr = state.lang === 'ar';

            if (state.activeQuestion) {
                const q = state.activeQuestion;
                let finalAnswer = q.answer; 
                let stepsToDisplay = [];
                if (isAr && q.steps_ar) stepsToDisplay = q.steps_ar;
                else if (!isAr && q.steps_en) stepsToDisplay = q.steps_en;
                else stepsToDisplay = q.steps || ["No steps / لا توجد خطوات"];

                if(isAr) finalAnswer = toArabicNumerals(finalAnswer);
                let html = `<h4>${isAr ? 'النتيجة:' : 'Result:'} <span style="color:var(--primary)">${finalAnswer}</span></h4>`;
                stepsToDisplay.forEach((s, i) => {
                    const stepNum = isAr ? toArabicNumerals(i+1) : (i+1);
                    html += `<div style="background:var(--bg-body); padding:10px; margin-bottom:5px; border-radius:8px;"><strong>${i18n[state.lang].step} ${stepNum}:</strong> ${s}</div>`;
                });
                container.innerHTML = html;
                updateGamification();
                return;
            }

            try {
                const norm = input.replace(/[٠-٩]/g, d => "0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)]);
                const res = math.evaluate(norm);
                const displayRes = isAr ? toArabicNumerals(res.toString()) : res.toString();
                let html = `<h4>${isAr ? 'النتيجة:' : 'Result:'} <span style="color:var(--primary)">${displayRes}</span></h4>`;
                html += `<div style="background:var(--bg-body); padding:10px; margin-top:10px; border-radius:8px;">${isAr ? 'تم الحساب تلقائياً' : 'Calculated automatically'}</div>`;
                container.innerHTML = html;
                if(document.getElementById('plot-area')) drawGraph(norm);
                updateGamification();
            } catch (e) {
                container.innerHTML = `<div style="color:var(--danger);">Error</div>`;
            }
        }

        function drawGraph(expr) {
            try {
                const plotDiv = document.getElementById('plot-area');
                if(!plotDiv) {
                    const newPlot = document.createElement('div');
                    newPlot.id = 'plot-area';
                    newPlot.style.width = "100%"; newPlot.style.height = "250px"; newPlot.style.marginTop = "10px";
                    document.getElementById('solution-output').after(newPlot);
                }
                const xVal = [], yVal = [];
                const compiled = math.compile(expr.split('=')[0]); 
                for(let x=-10; x<=10; x+=0.5) { xVal.push(x); yVal.push(compiled.evaluate({x:x})); }
                Plotly.newPlot('plot-area', [{x:xVal, y:yVal, mode:'lines', line:{color:'#008080'}}], {margin:{t:20,b:30,l:30,r:20}}, {displayModeBar:false});
            } catch(e){}
        }

        /* --- 6. LIBRARY --- */
        function handleFileImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    const questions = data.questions ? data.questions : (Array.isArray(data) ? data : []);
                    if(questions.length > 0) {
                        state.importedQuestions.push(...questions);
                        localStorage.setItem('importedQuestions', JSON.stringify(state.importedQuestions));
                        closeModal(); renderLibrary(); setView('library'); 
                        showToast("Imported!");
                    }
                } catch(err) { alert("Error parsing JSON"); }
            };
            reader.readAsText(file);
        }

        function renderLibrary() {
            const container = document.getElementById('library-list');
            if(state.importedQuestions.length === 0) {
                container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:2rem; color:var(--text-muted);"><i class="fas fa-folder-open fa-2x"></i><p>No questions.</p></div>`;
                return;
            }
            const isAr = state.lang === 'ar';
            container.innerHTML = state.importedQuestions.map((q, index) => {
                const category = isAr ? (q.category_ar || q.category_en) : q.category_en;
                const qText = isAr ? (q.question_ar || q.question_en) : q.question_en;
                return `
                <div class="q-card" onclick="loadQuestion(${index})">
                    <div style="flex:1">
                        <div style="font-size:0.8rem; color:var(--primary); font-weight:bold;">${category || 'Math'}</div>
                        <div style="font-weight:600; margin-top:5px;">${qText}</div>
                        <div class="badge" style="margin-top:5px; background:var(--border); color:var(--text-main);">${q.difficulty || 'Normal'}</div>
                    </div>
                    <i class="fas ${isAr ? 'fa-chevron-left' : 'fa-chevron-right'}"></i>
                </div>`;
            }).join('');
        }

        function loadQuestion(index) {
            state.activeQuestion = state.importedQuestions[index];
            const isAr = state.lang === 'ar';
            document.getElementById('math-input').value = isAr ? (state.activeQuestion.question_ar || state.activeQuestion.question_en) : state.activeQuestion.question_en;
            document.getElementById('active-question-banner').style.display = 'block';
            document.getElementById('solution-output').innerHTML = ''; 
            document.getElementById('check-result').innerHTML = '';
            document.getElementById('user-answer-input').value = '';
            setView('solver');
        }

        function clearActiveQuestion() {
            state.activeQuestion = null;
            document.getElementById('math-input').value = '';
            document.getElementById('active-question-banner').style.display = 'none';
        }

        function clearLibrary() {
            if(confirm("Delete all imported questions?")) {
                state.importedQuestions = [];
                localStorage.removeItem('importedQuestions');
                renderLibrary();
            }
        }

        /* --- 7. ADVANCED WHITEBOARD LOGIC --- */
        function addNewWhiteboard() {
            const container = document.getElementById('whiteboards-container');
            const id = `wb-${Date.now()}`;
            const wrapper = document.createElement('div');
            wrapper.className = 'canvas-container';
            wrapper.style.border = '1px solid var(--border)';
            wrapper.style.borderRadius = '8px';
            wrapper.style.padding = '10px';
            wrapper.style.marginBottom = '10px';
            wrapper.style.background = 'var(--bg-body)';

            wrapper.innerHTML = `
                <div class="wb-controls">
                    <div class="color-dot active" style="background:black;" data-col="black"></div>
                    <div class="color-dot" style="background:#008080;" data-col="#008080"></div>
                    <div class="color-dot" style="background:#e63946;" data-col="#e63946"></div>
                    <button class="btn btn-outline" style="padding:2px 8px; font-size:0.8rem;" data-action="eraser"><i class="fas fa-eraser"></i></button>
                    <button class="btn btn-outline" style="padding:2px 8px; font-size:0.8rem;" data-action="clear">Clear</button>
                    <button class="btn btn-outline" style="padding:2px 8px; font-size:0.8rem; color:var(--danger)" data-action="delete"><i class="fas fa-trash"></i></button>
                </div>
                <canvas id="${id}" class="whiteboard-canvas"></canvas>
            `;
            container.appendChild(wrapper);
            setupCanvas(id, wrapper);
        }

        function setupCanvas(canvasId, wrapper) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = 300; 
            ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 3; ctx.strokeStyle = 'black';
            let isDrawing = false;

            const start = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; ctx.moveTo(clientX - rect.left, clientY - rect.top); };
            const move = (e) => { if(!isDrawing) return; e.preventDefault(); const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; ctx.lineTo(clientX - rect.left, clientY - rect.top); ctx.stroke(); };
            const end = () => { isDrawing = false; };

            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end); canvas.addEventListener('mouseout', end);
            canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', end);

            wrapper.querySelectorAll('.color-dot').forEach(dot => {
                dot.addEventListener('click', () => {
                    ctx.globalCompositeOperation = 'source-over'; ctx.strokeStyle = dot.dataset.col; ctx.lineWidth = 3;
                    wrapper.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); dot.classList.add('active');
                });
            });
            wrapper.querySelector('[data-action="eraser"]').addEventListener('click', () => { ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = 20; });
            wrapper.querySelector('[data-action="clear"]').addEventListener('click', () => { ctx.clearRect(0,0,canvas.width, canvas.height); });
            wrapper.querySelector('[data-action="delete"]').addEventListener('click', () => { if(confirm("Delete this board?")) wrapper.remove(); });
        }

        /* --- 8. STUDENTS & DATA --- */
        function addStudent() {
            const name = document.getElementById('new-student-name').value;
            const points = document.getElementById('new-student-points').value;
            if(!name || !points) return alert("Fill Name and Points");
            state.students.push({ name: name, xp: parseInt(points) });
            localStorage.setItem('students', JSON.stringify(state.students));
            document.getElementById('new-student-name').value = '';
            document.getElementById('new-student-points').value = '';
            renderLeaderboardTable();
            showToast("Student Added!");
        }

        function deleteStudent(index) {
            if(confirm("Delete this student?")) {
                state.students.splice(index, 1);
                localStorage.setItem('students', JSON.stringify(state.students));
                renderLeaderboardTable();
            }
        }

        function renderLeaderboardTable() {
            const tbody = document.getElementById('leaderboard-table-body');
            const currentUser = { name: (state.lang==='ar'?'أنت':'You'), xp: state.xp, isMe: true };
            const allUsers = [...state.students, currentUser].sort((a,b) => b.xp - a.xp);
            
            tbody.innerHTML = allUsers.map((u, i) => {
                let actionBtn = '';
                if (!u.isMe) {
                    const originalIndex = state.students.indexOf(u);
                    actionBtn = `<button class="btn-sm-danger" onclick="deleteStudent(${originalIndex})"><i class="fas fa-trash"></i></button>`;
                }
                return `
                <tr class="${u.isMe ? 'lb-row-highlight' : ''}">
                    <td>${i+1}</td>
                    <td>${u.name} ${u.isMe ? '<i class="fas fa-user"></i>' : ''}</td>
                    <td>${state.lang==='ar' ? toArabicNumerals(u.xp) : u.xp}</td>
                    <td>${actionBtn}</td>
                </tr>
            `}).join('');
        }

        function clearAllData() {
            if(confirm("WARNING: This will delete ALL data (students, progress, questions). Are you sure?")) {
                localStorage.clear();
                location.reload();
            }
        }

        /* --- 9. GENERAL UTILS --- */
        function updateGamification() {
            state.solved++; state.xp += 10;
            localStorage.setItem('solved', state.solved);
            localStorage.setItem('xp', state.xp);
            renderStats();
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
        function renderStats() {
            const isAr = state.lang === 'ar';
            document.getElementById('solved-disp').textContent = isAr ? toArabicNumerals(state.solved) : state.solved;
            document.getElementById('header-xp-bar').style.width = `${state.xp % 100}%`;
            const lvl = Math.floor(state.xp / 100) + 1;
            document.getElementById('user-lvl-display').textContent = (isAr ? 'مستوى ' : 'Lvl ') + (isAr ? toArabicNumerals(lvl) : lvl);
        }
        function setView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            if(window.innerWidth < 900) document.body.classList.remove('sidebar-open');
            if(id === 'solver') setTimeout(() => { if(document.getElementById('whiteboards-container').children.length === 0) addNewWhiteboard(); }, 100);
        }
        function openModal(id) { document.getElementById('modal-'+id).classList.add('active'); }
        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active')); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.opacity = 1; t.style.transform = "translateX(-50%) translateY(-10px)";
            setTimeout(() => { t.style.opacity = 0; t.style.transform = "translateX(-50%) translateY(0)"; }, 3000);
        }
    </script>
</body>
</html>